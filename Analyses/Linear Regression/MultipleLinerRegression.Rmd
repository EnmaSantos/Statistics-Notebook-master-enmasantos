---
title: "Multiple Linear Regression Practice"
output: 
  html_document:
    theme: cerulean
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(mosaic)
library(car)
```

## Introduction

This analysis uses the "two-lines" multiple regression model to describe the price of a house according to the size of the living area and whether or not the house has a fireplace, using a subset of the `SaratogaHouses` dataset.

## Data Preparation

First, we load the data and filter it for newly constructed homes with three bedrooms.

```{r}
data(SaratogaHouses)

# Filter for 3 bedrooms and new construction
SH2 <- filter(SaratogaHouses, bedrooms == 3, newConstruction == "Yes")

# Verify the data
head(SH2)
```

## Two-Lines Regression Model

We fit a multiple regression model with an interaction term between `livingArea` and `fireplaces`. This allows for different slopes (two lines) for homes with and without fireplaces.

The model is:
$$ Y_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \beta_3 X_{1i}X_{2i} + \epsilon_i $$
where:
* $Y_i$ is Price
* $X_{1i}$ is Living Area
* $X_{2i}$ is Fireplaces (0 or 1)

```{r}
# Fit the regression model
# filling in the blanks: lm(price ~ livingArea + fireplaces + livingArea:fireplaces, data=SH2)
sh2.lm <- lm(price ~ livingArea + fireplaces + livingArea:fireplaces, data=SH2)

# Show the summary results
summary(sh2.lm)
```

## Interpretation

From the summary above, we can extract the coefficients to interpret the effect of living area and fireplaces.

*   **$\beta_1$ (livingArea)**: The change in the average price of a home *without* a fireplace as the living area increases by 1 additional square foot.
*   **$\beta_2$ (fireplaces)**: The difference in the average price of a home with a fireplace as compared to a home without a fireplace for homes with zero square feet of living area (intercept adjustment).
*   **$\beta_3$ (livingArea:fireplaces)**: The change in the effect of 1 additional square foot in the living area on the average price of homes with a fireplace as compared to homes without a fireplace (slope adjustment).

## Hypothesis Testing

We can check the p-values for the specific coefficients.

### Test for Fireplace Effect (Intercept Difference)
$H_0: \beta_2 = 0$ vs $H_a: \beta_2 \neq 0$

```{r}
# P-value for fireplaces coefficient
p_val_beta2 <- summary(sh2.lm)$coefficients["fireplaces", "Pr(>|t|)"]
p_val_beta2
```

### Test for Interaction Effect (Slope Difference)
$H_0: \beta_3 = 0$ vs $H_a: \beta_3 \neq 0$

```{r}
# P-value for interaction term
p_val_beta3 <- summary(sh2.lm)$coefficients["livingArea:fireplaces", "Pr(>|t|)"]
p_val_beta3
```

## Visualization

We visualize the model by plotting the data points and adding the two regression lines.

```{r}
# Plot the data
plot(price ~ livingArea, data=SH2, col=as.factor(fireplaces), pch=16,
     main="Price vs Living Area by Fireplace Presence",
     xlab="Living Area (sq ft)", ylab="Price ($)")

# Add legend
legend("topleft", legend=c("No Fireplace", "Fireplace"), col=1:2, pch=16)

# Extract coefficients
b <- coef(sh2.lm)

# Line for No Fireplace (fireplaces = 0): y = b0 + b1*x
abline(a = b[1], b = b["livingArea"], col=1, lwd=2)

# Line for Fireplace (fireplaces = 1): y = (b0 + b2) + (b1 + b3)*x
# Intercept is b[1] + b["fireplaces"]
# Slope is b["livingArea"] + b["livingArea:fireplaces"]
abline(a = b[1] + b["fireplaces"], 
       b = b["livingArea"] + b["livingArea:fireplaces"], 
       col=2, lwd=2)
```

## Diagnostics

We check the appropriateness of the model using diagnostic plots.

```{r fig.width=10, fig.height=4}
par(mfrow=c(1,3))

# 1. Residuals vs Fitted
plot(sh2.lm, which=1)

# 2. QQ Plot of Residuals
qqPlot(sh2.lm$residuals, id=FALSE)

# 3. Plot of Residuals (Index plot)
plot(sh2.lm$residuals, main="Residuals vs Index", ylab="Residuals")

par(mfrow=c(1,1)) # Reset layout
```

### Inspecting Potential Outliers

We can inspect the rows identified as potential outliers in the diagnostic plots.

```{r}
# Inspecting specific rows mentioned in the problem description
outliers <- SH2[c(1, 2, 3, 4, 15, 16, 17, 18, 24, 25, 26), ]
outliers
```

## Quadratic Regression Practice

This section uses the `airquality` dataset to model Temperature as a quadratic function of Month.

### Model Fitting

The model is: $Y_i = \beta_0 + \beta_1 X_i + \beta_2 X_i^2 + \epsilon_i$
where $Y_i$ is Temperature and $X_i$ is Month.

```{r}
data(airquality)

# Fit the quadratic model
aq.lm <- lm(Temp ~ Month + I(Month^2), data=airquality)

# Show summary
summary(aq.lm)
```

### Diagnostics

We check the appropriateness of the model.

```{r fig.width=10, fig.height=4}
par(mfrow=c(1,3))
plot(aq.lm, which=1)
qqPlot(aq.lm$residuals, id=FALSE)
plot(aq.lm$residuals, main="Residuals vs Order", ylab="Residuals")
par(mfrow=c(1,1))
```

### Prediction

Predicting the average high temperature for July 4th (Month = 7.129032).

```{r}
# Prediction for July 4th
july4_month <- 7 + 4/31
pred_july4 <- predict(aq.lm, newdata=data.frame(Month=july4_month))
pred_july4
```

### Visualization

Visualizing the quadratic fit and the prediction.

```{r}
# Plot the data
plot(Temp ~ Month, data=airquality, pch=16, col="gray",
     main="Temperature vs Month (Quadratic Fit)",
     xlab="Month", ylab="Temperature (F)")

# Add the quadratic curve
b <- coef(aq.lm)
curve(b[1] + b[2]*x + b[3]*x^2, add=TRUE, col="skyblue2", lwd=2)

# Add the prediction lines and point
lines(c(july4_month, july4_month), c(0, pred_july4), lty=2, col="firebrick")
lines(c(0, july4_month), c(pred_july4, pred_july4), lty=2, col="firebrick")
points(july4_month, pred_july4, cex=1.2, col="red", pch=16)
text(july4_month + 0.5, pred_july4, "Predicted Temp", cex=0.8, pos=3)
```

### Vertex Calculation

Finding the warmest month (vertex of the parabola).
Vertex x-coordinate = $-b_1 / (2b_2)$.

```{r}
# Calculate vertex
vertex_x <- -b[2] / (2 * b[3])
vertex_y <- b[1] + b[2]*vertex_x + b[3]*vertex_x^2

cat("Vertex Month:", vertex_x, "\n")
cat("Max Temperature:", vertex_y, "\n")
```

## RailTrail Regression Practice

This section uses the `RailTrail` dataset to model the volume of users as a function of high temperature and rain.

### Data Preparation

We create a new column `rain` which is 1 if `precip > 0` and 0 otherwise.

```{r}
data(RailTrail)

# Create rain column
RailTrail <- mutate(RailTrail, rain = ifelse(precip > 0, 1, 0))

# Verify the new column
head(RailTrail)
```

### Initial Visualization

We visualize the relationship between volume and high temperature, colored by rain.

```{r}
palette(c("orange","skyblue"))
plot(volume ~ hightemp, data=RailTrail, col=as.factor(rain), pch=16,
     main="RailTrail Data Set", xlab="High Temp (F)", ylab="Volume")
legend("topleft", legend=c("No Rain", "Rain"), col=palette(), pch=16)
```

### Interaction Model (Two-Lines)

We first fit a model allowing for interaction between high temperature and rain.

$$ Y_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \beta_3 X_{1i}X_{2i} + \epsilon_i $$

```{r}
rail_interaction.lm <- lm(volume ~ hightemp + rain + hightemp:rain, data=RailTrail)
summary(rail_interaction.lm)
```

### Reduced Model (Parallel Slopes)

Since the interaction term is not significant, we fit a reduced model without the interaction term.

$$ Y_i = \beta_0 + \beta_1 X_{1i} + \beta_2 X_{2i} + \epsilon_i $$

```{r}
# Fit the reduced model
rail.lm <- lm(volume ~ hightemp + rain, data=RailTrail)
summary(rail.lm)
```

### Visualization of Reduced Model

We plot the parallel regression lines.

```{r}
palette(c("orange","skyblue"))
plot(volume ~ hightemp, data=RailTrail, col=as.factor(rain), pch=16,
     main="RailTrail Data Set (Parallel Slopes)", xlab="High Temp (F)", ylab="Volume")
legend("topleft", legend=c("No Rain", "Rain"), col=palette(), pch=16)

# Extract coefficients
b <- coef(rail.lm)

# Line for No Rain (rain=0): y = b0 + b1*x
curve(b[1] + b["hightemp"]*x, add=TRUE, col="orange", lwd=2)

# Line for Rain (rain=1): y = (b0 + b2) + b1*x
curve((b[1] + b["rain"]) + b["hightemp"]*x, add=TRUE, col="skyblue", lwd=2)
```

### Diagnostics

We check the appropriateness of the model using diagnostic plots.

```{r fig.width=10, fig.height=4}
par(mfrow=c(1,3))
plot(rail.lm, which=1)
qqPlot(rail.lm$residuals, id=FALSE)
plot(rail.lm$residuals, main="Residuals vs Order", ylab="Residuals")
par(mfrow=c(1,1))
```

